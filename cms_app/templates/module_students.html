{% extends "layout.html" %}
{% block page_class %}students-module module-cards{% endblock %}
{% block content %}
<div class="container py-4">
  {% set role_display = (role or (current_user.role if current_user.is_authenticated else 'Guest')) %}
  {% set role_display_lower = (role_display or '')|lower %}
  <div class="section-header d-flex align-items-center justify-content-between mb-2">
    <h3 class="mb-0 title d-flex align-items-center">Students Module <span class="role-badge ms-2">{{ role_display|capitalize }}</span></h3>
    <div class="actions"></div>
  </div>
  {% if role_display_lower == 'admin' %}
    <div class="small text-muted" data-bs-toggle="tooltip" data-bs-placement="right" title="Admins can view, add, and edit students across programs and divisions.">Admin: Elevated access on this module.</div>
  {% endif %}
  <p class="text-muted soft-hint">Maintain student records and view academic information.</p>

  <div class="row g-3">
    <div class="col-md-6">
      <div class="card mod-card mod-card--quick">
        <div class="card-header">Quick Actions</div>
        <div class="card-body">
          <div class="card-icon" aria-hidden="true"><i class="bi bi-lightning-charge"></i></div>
          <div class="list-group">
            <a class="list-group-item list-group-item-action" href="{{ url_for('main.students') }}">View Students</a>
            {% if (role or '') in ['admin','principal','clerk'] %}
              <a class="list-group-item list-group-item-action" href="{{ url_for('main.students_new') }}">Add Student</a>
              <a class="list-group-item list-group-item-action" href="{{ url_for('main.students_import') }}">Bulk Import Students (Clerk)</a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card mod-card mod-card--links">
        <div class="card-header">Helpful Links</div>
        <div class="card-body">
          <div class="card-icon" aria-hidden="true"><i class="bi bi-info-circle"></i></div>
          <ul class="list-unstyled mb-0">
            <li>Use program and semester fields to segment students.</li>
            <li>Each student page links to attendance and grades views.</li>
          </ul>
        </div>
      </div>
    </div>
    <!-- Primary Action: Hybrid Global Search (Omni-Search) -->
  <div class="card mod-card mod-card--search">
    <div class="card-header">Search Students</div>
    <div class="card-body">
      <div class="card-icon" aria-hidden="true"><i class="bi bi-search"></i></div>
      <div class="row g-2 align-items-center">
        <div class="col-12">
          <label class="form-label">Search Student (Instant)</label>
          <div class="position-relative">
            <div class="input-group input-group-lg">
              <input type="text" id="smSearch" class="form-control" placeholder="Loading directory..." disabled autocomplete="off" />
              <button class="btn btn-outline-secondary" type="button" id="forceSearchBtn" title="Force Server Search"><i class="bi bi-cloud-download"></i></button>
            </div>
            <div id="smSuggestions" class="list-group position-absolute w-100 shadow-lg" style="z-index:1000; max-height:400px; overflow:auto; display:none;"></div>
          </div>
          <div class="d-flex justify-content-between mt-2">
             <div class="form-text"><i class="bi bi-info-circle me-1"></i> Instant search. If not found, press Enter to search server.</div>
             <div class="small text-muted" id="cacheStatus">Initializing...</div>
          </div>
        </div>
      </div>
      <script id="studentsConfig" type="application/json">{{ {'medium_program_ids': (medium_program_ids or []), 'default_medium_map': (default_medium_map or {}) } | tojson }}</script>
    </div>
  </div>

  <div class="mt-3">
    <button class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#studentsPower">Power Actions</button>
    <div id="studentsPower" class="collapse mt-2">
      <div class="card mod-card mod-card--links">
        <div class="card-body">
          <div class="row g-2">
            <div class="col-12"><div class="small text-muted soft-hint">Advanced links for power users.</div></div>
            <div class="col-md-4"><a class="btn btn-sm btn-outline-primary w-100" href="{{ url_for('main.subjects_list') }}">Subjects</a></div>
            <div class="col-md-4"><a class="btn btn-sm btn-outline-primary w-100" href="{{ url_for('main.attendance_mark') }}">Mark Attendance</a></div>
            {% if (role or '') in ['admin','principal'] %}
              <div class="col-md-4"><a class="btn btn-sm btn-outline-primary w-100" href="{{ url_for('main.enroll_core') }}">Core Enrollment</a></div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  (function(){
    // -----------------------------------------------------------------------
    // Hybrid Search Engine (Local Cache + API Fallback) for Student Module
    // -----------------------------------------------------------------------
    const searchInput = document.getElementById('smSearch');
    const suggBox = document.getElementById('smSuggestions');
    const cacheStatus = document.getElementById('cacheStatus');
    const forceBtn = document.getElementById('forceSearchBtn');
    const studentsShowUrlTemplate = "{{ url_for('main.students_show', enrollment_no='__ENR__') }}";

    let allStudents = [];
    let isLoaded = false;
    let debounceTimer;
    
    // 1. Initial Load (Tier 1)
    async function loadStudents() {
      try {
        cacheStatus.innerText = "Downloading directory...";
        const resp = await fetch("{{ url_for('main.api_students_search') }}?limit=2000"); 
        const jsonResp = await resp.json();
        // API returns {success: true, data: {items: [...]}}
        const items = (jsonResp.data && jsonResp.data.items) || (jsonResp.items) || [];
        allStudents = items;
        isLoaded = true;
        
        searchInput.disabled = false;
        searchInput.placeholder = "Start typing Name or Enrollment No...";
        cacheStatus.innerText = `${allStudents.length} students loaded locally.`;
      } catch(e) {
        console.error("Failed to load students", e);
        cacheStatus.innerText = "Offline mode or server error.";
        searchInput.disabled = false;
        searchInput.placeholder = "Search server directly...";
      }
    }
    loadStudents();

    // 2. Hybrid Search Logic
    function performSearch(query, forceServer = false) {
      if (!query) {
         suggBox.style.display = 'none';
         return;
      }
      
      const q = query.toLowerCase();
      let matches = allStudents.filter(s => {
        if (s.enrollment_no && s.enrollment_no.toLowerCase().includes(q)) return true;
        const full = (s.name || '').toLowerCase();
        return full.includes(q);
      }).slice(0, 15);

      if (matches.length > 0 && !forceServer) {
        showSuggestions(matches, false);
      } else {
        fetchServerSearch(query);
      }
    }

    async function fetchServerSearch(query) {
      suggBox.innerHTML = '<div class="list-group-item text-muted"><span class="spinner-border spinner-border-sm me-2"></span>Searching server archive...</div>';
      suggBox.style.display = 'block';
      
      try {
        const url = new URL("{{ url_for('main.api_students_search') }}", window.location.origin);
        url.searchParams.set('q', query);
        url.searchParams.set('limit', 50);
        
        const resp = await fetch(url.toString());
        const jsonResp = await resp.json();
        const items = (jsonResp.data && jsonResp.data.items) || (jsonResp.items) || [];
        
        if (items.length === 0) {
           suggBox.innerHTML = '<div class="list-group-item text-center text-muted py-3">No matching students found on server.</div>';
        } else {
           showSuggestions(items, true);
        }
      } catch(e) {
        suggBox.innerHTML = '<div class="list-group-item text-danger">Server search failed. Check connection.</div>';
      }
    }

    // 3. Render
    function showSuggestions(items, isServerResult) {
      suggBox.innerHTML = '';
      
      const header = document.createElement('div');
      header.className = 'list-group-item bg-light fw-bold text-muted small py-2 d-flex justify-content-between';
      header.innerHTML = `<span>${isServerResult ? 'Server Results' : 'Instant Results'}</span><span class="badge bg-secondary">${items.length}</span>`;
      suggBox.appendChild(header);

      items.forEach(it => {
         const item = document.createElement('div');
         item.className = 'list-group-item list-group-item-action py-2';
         
         const href = studentsShowUrlTemplate.replace('__ENR__', encodeURIComponent(it.enrollment_no));

         item.innerHTML = `
            <div class="row align-items-center">
              <div class="col-8">
                <div class="fw-bold text-dark small">${it.name}</div>
                <div class="small text-muted" style="font-size:0.75rem;">${it.enrollment_no} â€¢ ${it.program_name || ''} Sem ${it.semester}</div>
              </div>
              <div class="col-4 text-end">
                <a href="${href}" class="btn btn-xs btn-primary rounded-pill px-3 py-1" style="font-size:0.8rem;">
                  View Profile
                </a>
              </div>
            </div>
         `;
         suggBox.appendChild(item);
      });
      
      if (!isServerResult) {
          const footer = document.createElement('div');
          footer.className = 'list-group-item list-group-item-action text-center text-primary small py-2';
          footer.style.cursor = 'pointer';
          footer.innerHTML = '<i class="bi bi-cloud-download me-1"></i> Not here? Search entire server';
          footer.onclick = () => fetchServerSearch(searchInput.value);
          suggBox.appendChild(footer);
      }
      
      suggBox.style.display = 'block';
    }

    // 4. Event Listeners
    searchInput.addEventListener('input', function() {
      const q = (this.value || '').trim();
      if (debounceTimer) clearTimeout(debounceTimer);
      
      if (q.length < 2) {
        suggBox.style.display = 'none';
        return;
      }
      
      debounceTimer = setTimeout(() => performSearch(q), 300);
    });
    
    searchInput.addEventListener('keydown', function(e) {
       if (e.key === 'Enter') {
           e.preventDefault();
           performSearch(this.value, true);
       }
    });
    
    forceBtn.addEventListener('click', () => performSearch(searchInput.value, true));

    document.addEventListener('click', function(ev){
      if (!suggBox.contains(ev.target) && ev.target !== searchInput && ev.target !== forceBtn) {
        suggBox.style.display = 'none';
      }
    });

  })();
</script>
{% endblock %}