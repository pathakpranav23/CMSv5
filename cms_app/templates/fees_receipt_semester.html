{% extends "layout.html" %}
{% block content %}
<style>
  @page { size: A4; margin: 6mm; }
  @media screen {
    /* Show only one copy on screen; both copies on print */
    .receipt-copies .receipt-copy:nth-of-type(2) { display: none; }
  }
  @media print {
    .no-print { display: none !important; }
    /* Hide app chrome during print */
    .sidebar, .app-sidebar, .sidebar-backdrop, .app-header, .app-footer,
    .enhanced-nav, .mobile-topbar, nav, aside, .page-header { display: none !important; }
    .app-main main, main.container, .container, .content { margin: 0 !important; padding: 0 !important; width: 100% !important; }
    /* Stack copies vertically on one A4 page */
    .receipt-copies { display: block; }
    .receipt-copy { page-break-inside: avoid; page-break-after: always; margin: 0; }
    .receipt-copy:last-child { page-break-after: auto; }
    .receipt-header img { height: 44px; width: auto; }
    .brand-title-main { font-weight: 600; font-size: 0.95rem; }
    .brand-title-sub { font-size: 0.8rem; color: #6c757d; }
    /* Compact tables and spacing */
    .receipt-copy table { font-size: 11px; }
    .receipt-copy table.table th, .receipt-copy table.table td { padding: 3px 5px; }
    /* Center the receipt table within page for filing margin */
    .receipt-copy .table-responsive { max-width: 180mm; margin: 0 auto; }
    .receipt-student { margin-bottom: 4px; font-size: 11px; }
    .card { margin-bottom: 4mm; }
    /* Compact disclaimer/footer note */
    #receipt-disclaimer, .receipt-disclaimer, .receipt-footer-note { font-size: 10px; margin-top: 4mm; }

  }
  .receipt-header img { height: 72px; width: auto; }
  .brand-title-main { font-weight: 600; }
  .brand-title-sub { font-size: 0.9rem; color: #6c757d; }
  .receipt-card-total { font-size: 2rem; }
  .receipt-student { margin-bottom: 6px; font-size: 14px; }
</style>

<div class="container py-4">
  <div class="no-print d-flex justify-content-end gap-2 mb-2">
    <a class="btn btn-outline-primary" href="{{ url_for('main.students') }}?program_id={{ selected_program.program_id if selected_program else '' }}&semester={{ semester or '' }}">Search Students</a>
    <button class="btn btn-primary" onclick="window.print()">Print</button>
  </div>
  {% set role_display = (current_user.role if current_user.is_authenticated else 'Guest') %}
  <div class="section-header d-flex justify-content-between align-items-center mb-3 no-print">
    <h2 class="mb-0 title d-flex align-items-center">Semester Fees Receipt <span class="role-badge ms-2">{{ role_display|capitalize }}</span></h2>
    <div class="actions">
       <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#batchOps" aria-expanded="false" aria-controls="batchOps">
         <i class="bi bi-gear-wide-connected me-1"></i> Batch Operations
       </button>
    </div>
  </div>

  <!-- Primary Action: Hybrid Global Search (Omni-Search) -->
  <div class="card mb-3 no-print quick-pay-card shadow-sm border-primary">
    <div class="card-body p-4">
      <div class="row g-2 align-items-center">
        <div class="col-12">
          <label class="form-label fw-bold text-primary mb-2"><i class="bi bi-search me-1"></i> Search Student for Payment</label>
          <div class="position-relative">
            <div class="input-group input-group-lg">
              <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
              <input type="text" id="qpSearch" class="form-control border-start-0 ps-0 form-control-lg" placeholder="Loading directory..." disabled autocomplete="off" autofocus />
              <button class="btn btn-outline-secondary" type="button" id="forceSearchBtn" title="Force Server Search"><i class="bi bi-cloud-download"></i></button>
            </div>
            <div id="qpSuggestions" class="list-group position-absolute w-100 shadow-lg" style="z-index: 1000; max-height: 400px; overflow-y:auto; display:none; top: 100%;"></div>
          </div>
          <div class="d-flex justify-content-between mt-2">
            <div class="form-text"><i class="bi bi-info-circle me-1"></i> Instant search. If not found, press Enter to search server.</div>
            <div class="small text-muted" id="cacheStatus">Initializing...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      // -----------------------------------------------------------------------
      // Hybrid Search Engine (Local Cache + API Fallback)
      // -----------------------------------------------------------------------
      const searchInput = document.getElementById('qpSearch');
      const suggBox = document.getElementById('qpSuggestions');
      const cacheStatus = document.getElementById('cacheStatus');
      const forceBtn = document.getElementById('forceSearchBtn');
      const feesPaymentUrlTemplate = "{{ url_for('main.fees_payment', enrollment_no='__ENR__') }}";
      
      let allStudents = [];
      let isLoaded = false;
      let debounceTimer;

      // 1. Initial Load (Tier 1)
      async function loadStudents() {
        try {
          cacheStatus.innerText = "Downloading directory...";
          const resp = await fetch("{{ url_for('main.api_students_search') }}?limit=2000"); 
          const jsonResp = await resp.json();
          // API returns {success: true, data: {items: [...]}}
          const items = (jsonResp.data && jsonResp.data.items) || (jsonResp.items) || [];
          allStudents = items;
          isLoaded = true;
          
          searchInput.disabled = false;
          searchInput.placeholder = "Start typing Name, Surname, or Enrollment No...";
          cacheStatus.innerText = `${allStudents.length} students loaded locally.`;
          
          // Auto-focus
          searchInput.focus();
        } catch(e) {
          console.error("Failed to load students", e);
          cacheStatus.innerText = "Offline mode or server error.";
          searchInput.disabled = false;
          searchInput.placeholder = "Search server directly...";
        }
      }

      loadStudents();

      // 2. Hybrid Search Logic
      function performSearch(query, forceServer = false) {
        if (!query) {
           suggBox.style.display = 'none';
           return;
        }
        
        // Step A: Local Search
        const q = query.toLowerCase();
        let matches = allStudents.filter(s => {
          if (s.enrollment_no && s.enrollment_no.toLowerCase().includes(q)) return true;
          const full = (s.name || '').toLowerCase();
          return full.includes(q);
        }).slice(0, 15);

        // Step B: Decision - Show Local or Ask Server?
        if (matches.length > 0 && !forceServer) {
          showSuggestions(matches, false);
        } else {
          // If local failed OR user forced it, go to Server (Tier 2)
          fetchServerSearch(query);
        }
      }

      async function fetchServerSearch(query) {
        suggBox.innerHTML = '<div class="list-group-item text-muted"><span class="spinner-border spinner-border-sm me-2"></span>Searching server archive...</div>';
        suggBox.style.display = 'block';
        
        try {
          const url = new URL("{{ url_for('main.api_students_search') }}", window.location.origin);
          url.searchParams.set('q', query);
          url.searchParams.set('limit', 50); // Deep search gets more specific results
          
          const resp = await fetch(url.toString());
          const jsonResp = await resp.json();
          // API returns {success: true, data: {items: [...]}}
          const items = (jsonResp.data && jsonResp.data.items) || (jsonResp.items) || [];
          
          if (items.length === 0) {
             suggBox.innerHTML = '<div class="list-group-item text-center text-muted py-3">No matching students found on server.</div>';
          } else {
             showSuggestions(items, true);
          }
        } catch(e) {
          suggBox.innerHTML = '<div class="list-group-item text-danger">Server search failed. Check connection.</div>';
        }
      }

      // 3. Render
      function showSuggestions(items, isServerResult) {
        suggBox.innerHTML = '';
        
        const header = document.createElement('div');
        header.className = 'list-group-item bg-light fw-bold text-muted small py-2 d-flex justify-content-between';
        header.innerHTML = `<span>${isServerResult ? 'Server Results' : 'Instant Results'}</span><span class="badge bg-secondary">${items.length}</span>`;
        suggBox.appendChild(header);

        items.forEach(it => {
           const item = document.createElement('div');
           item.className = 'list-group-item list-group-item-action py-2';
           
           let paymentUrl = feesPaymentUrlTemplate.replace('__ENR__', encodeURIComponent(it.enrollment_no));
           const params = new URLSearchParams();
           if (it.semester) params.set('semester', it.semester);
           if (it.program_id) params.set('program_id', it.program_id);
           paymentUrl += '?' + params.toString();

           item.innerHTML = `
              <div class="row align-items-center">
                <div class="col-2">
                   <div class="ratio ratio-1x1 rounded-circle bg-secondary bg-opacity-10 overflow-hidden" style="width: 40px; height: 40px;">
                     ${it.photo_url ? `<img src="${it.photo_url}" class="w-100 h-100 object-fit-cover">` : '<i class="bi bi-person-fill text-muted fs-5 d-flex align-items-center justify-content-center h-100"></i>'}
                   </div>
                </div>
                <div class="col-6">
                  <div class="fw-bold text-dark small">${it.name}</div>
                  <div class="small text-muted" style="font-size:0.75rem;">${it.enrollment_no} • ${it.program_name || ''} Sem ${it.semester}</div>
                </div>
                <div class="col-4 text-end">
                  <a href="${paymentUrl}" class="btn btn-xs btn-primary rounded-pill px-3 py-1" style="font-size:0.8rem;">
                    Select
                  </a>
                </div>
              </div>
           `;
           suggBox.appendChild(item);
        });
        
        // Add "Search Server" option at bottom if local result
        if (!isServerResult) {
            const footer = document.createElement('div');
            footer.className = 'list-group-item list-group-item-action text-center text-primary small py-2';
            footer.style.cursor = 'pointer';
            footer.innerHTML = '<i class="bi bi-cloud-download me-1"></i> Not here? Search entire server';
            footer.onclick = () => fetchServerSearch(searchInput.value);
            suggBox.appendChild(footer);
        }
        
        suggBox.style.display = 'block';
      }

      // 4. Event Listeners
      searchInput.addEventListener('input', function() {
        const q = (this.value || '').trim();
        if (debounceTimer) clearTimeout(debounceTimer);
        
        if (q.length < 2) {
          suggBox.style.display = 'none';
          return;
        }
        
        // 300ms delay for smooth typing
        debounceTimer = setTimeout(() => performSearch(q), 300);
      });
      
      // Force search on Enter
      searchInput.addEventListener('keydown', function(e) {
         if (e.key === 'Enter') {
             e.preventDefault();
             performSearch(this.value, true); // Force server search
         }
      });
      
      forceBtn.addEventListener('click', () => performSearch(searchInput.value, true));

      // Hide on click outside
      document.addEventListener('click', function(ev){
        if (!suggBox.contains(ev.target) && ev.target !== searchInput && ev.target !== forceBtn) {
          suggBox.style.display = 'none';
        }
      });

    })();
  </script>

  {% if selected_program and semester %}
    <div class="text-center mb-3 receipt-header no-print">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Parekh Colleges Logo" />
      <div class="brand-title-main">The Group of Parekh Colleges - Mahuva</div>
      <div class="brand-title-sub">Managed by Shri Balvant Parekh Education Trust (SBPET)</div>
      <div class="fw-bold mt-2">{{ selected_program.program_name }}</div>
      <div class="text-muted">Semester {{ semester }}</div>
      {% if show_medium %}
        <div class="text-muted">Medium: {{ (filters.medium or '') and filters.medium or 'Common' }}</div>
      {% endif %}
      {% if verified_payment and verified_payment.receipt_no %}
        <div class="mt-1">
          <span class="badge bg-light text-dark">Receipt No.: {{ verified_payment.receipt_no }}</span>
        </div>
      {% elif preview_receipt_no %}
        <div class="mt-1">
          <span class="badge bg-light text-dark">Receipt No.: {{ preview_receipt_no }}</span>
        </div>
      {% endif %}
      {% if filters.mode == 'frozen' %}
        <div class="badge text-bg-success">Finalized Receipt</div>
      {% else %}
        <div class="badge text-bg-warning">Preview</div>
      {% endif %}
    </div>

    <div class="card mb-3 no-print">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <div class="text-muted">Total fees for Semester {{ semester }}</div>
          <div class="display-6">₹ {{ (total_amount or 0)|round(2) }}</div>
        </div>
      </div>
    </div>

    <div class="card mb-3 no-print quick-pay-card">
      <div class="card-header card-header-standard">
        <div class="d-flex align-items-center justify-content-between">
          <div class="card-title d-flex align-items-center gap-2 mb-0"><i class="bi bi-qr-code"></i> Quick Payment</div>
          <span class="badge bg-primary">Semester {{ semester }}{% if show_medium and filters.medium %} • {{ filters.medium }}{% endif %}</span>
        </div>
      </div>
      <div class="card-body">
        <form id="quickPayForm" method="get" action="">
          <div class="row g-2 align-items-end">
            <div class="col-12">
              <label class="form-label fw-bold">Find Student</label>
              <div class="position-relative">
                <div class="input-group input-group-lg">
                  <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                  <input type="text" id="qpSearch" class="form-control border-start-0 ps-0" placeholder="Type Name, Surname, or Enrollment No..." autocomplete="off" />
                </div>
                <div id="qpSuggestions" class="list-group position-absolute w-100 shadow-lg" style="z-index: 1000; max-height: 400px; overflow-y:auto; display:none; top: 100%;"></div>
              </div>
              <div class="form-text mt-2"><i class="bi bi-info-circle me-1"></i> Start typing to see student details. Click "Select" to proceed to payment.</div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Config values injected via data attributes to avoid Jinja inside JS -->
    <div id="qpConfig" class="d-none"
         data-students-url="{{ url_for('main.students') }}"
         data-fees-payment-url-template="{{ url_for('main.fees_payment', enrollment_no='__ENR__') }}"
         data-program-id="{{ selected_program.program_id if selected_program else '' }}"
         data-semester="{{ semester or '' }}"
         data-medium="{{ (filters.medium or '') }}">
    </div>

    <script>
      (function(){
        const searchInput = document.getElementById('qpSearch');
        const suggBox = document.getElementById('qpSuggestions');
        const cfgEl = document.getElementById('qpConfig');
        const feesPaymentUrlTemplate = (cfgEl && cfgEl.dataset && cfgEl.dataset.feesPaymentUrlTemplate) || '';
        const programId = (cfgEl && cfgEl.dataset && cfgEl.dataset.programId ? Number(cfgEl.dataset.programId) : null);
        const semesterVal = (cfgEl && cfgEl.dataset && cfgEl.dataset.semester ? Number(cfgEl.dataset.semester) : null);
        const mediumVal = (cfgEl && cfgEl.dataset && cfgEl.dataset.medium) || '';
        const hasContext = Boolean(programId) && Boolean(semesterVal);

        // Gate search only if we wanted to enforce context, but now it's global.
        // However, we still need to handle the payment URL construction dynamically.
        
        function clearSuggestions(){ suggBox.innerHTML = ''; suggBox.style.display = 'none'; }
        
        function showSuggestions(items){
          if (!items || items.length === 0) { 
            suggBox.innerHTML = '<div class="list-group-item text-center text-muted py-3">No students found matching your query.</div>';
            suggBox.style.display = 'block';
            return; 
          }
          suggBox.innerHTML = '';
          
          // Header for results
          const header = document.createElement('div');
          header.className = 'list-group-item bg-light fw-bold text-muted small py-2';
          header.innerHTML = '<div class="row"><div class="col-2">Photo</div><div class="col-6">Student Details</div><div class="col-4 text-end">Action</div></div>';
          suggBox.appendChild(header);

          items.forEach(function(it){
            const item = document.createElement('div');
            item.className = 'list-group-item list-group-item-action py-3';
            
            // Construct Name
            const fullName = [it.name, it.father_name, it.surname].filter(Boolean).join(' ');
            const enrollment = it.enrollment_no || 'N/A';
            const programInfo = it.program_name ? `${it.program_name} Sem ${it.semester}` : '';
            
            // AUTO-CONTEXT SWITCHING URL
            // We use the student's actual semester and program_id from the search result
            // instead of the currently loaded page context.
            // This ensures clicking a Sem 5 student loads the Sem 5 receipt page.
            let paymentUrl = feesPaymentUrlTemplate.replace('__ENR__', encodeURIComponent(enrollment));
            
            // Append the student's actual semester to the URL parameters
            const params = new URLSearchParams();
            if (it.semester) params.set('semester', it.semester);
            if (it.program_id) params.set('program_id', it.program_id);
            // We don't know medium from search result yet (API update needed ideally), but common usually works.
            // If medium is needed, the next page load will handle it or default it.
            
            paymentUrl += '?' + params.toString();

            item.innerHTML = `
              <div class="row align-items-center">
                <div class="col-2">
                  <div class="ratio ratio-1x1 rounded-circle bg-secondary bg-opacity-10 overflow-hidden" style="width: 48px; height: 48px;">
                     ${it.photo_url ? `<img src="${it.photo_url}" class="w-100 h-100 object-fit-cover" alt="Student">` : '<i class="bi bi-person-fill text-muted fs-4 d-flex align-items-center justify-content-center h-100"></i>'}
                  </div>
                </div>
                <div class="col-6">
                  <div class="fw-bold text-dark">${fullName}</div>
                  <div class="small text-muted"><i class="bi bi-card-heading me-1"></i> ${enrollment}</div>
                  <div class="small text-secondary">${programInfo}</div>
                </div>
                <div class="col-4 text-end">
                  <a href="${paymentUrl}" class="btn btn-sm btn-primary rounded-pill px-3">
                    Select <i class="bi bi-arrow-right ms-1"></i>
                  </a>
                </div>
              </div>
            `;
            suggBox.appendChild(item);
          });
          suggBox.style.display = 'block';
        }

        let debounceTimer;
        searchInput.addEventListener('input', function(){
          const q = (searchInput.value || '').trim();
          if (debounceTimer) { clearTimeout(debounceTimer); }
          if (q.length < 2) { clearSuggestions(); return; }
          
          debounceTimer = setTimeout(function(){
            // For global search, we don't strictly limit by current page context anymore
            const params = new URLSearchParams({ q: q });
            // We can optionally pass current context as hint, but backend now handles global search if 'q' is present.
            if (programId) params.set('program_id', String(programId));
            
            fetch(`${window.location.origin}/api/students/search?` + params.toString())
              .then(r => r.ok ? r.json() : Promise.reject())
              .then(data => showSuggestions((data && data.items) || []))
              .catch(() => clearSuggestions());
          }, 300);
        });

        document.addEventListener('click', function(ev){
          if (!suggBox.contains(ev.target) && ev.target !== searchInput) { clearSuggestions(); }
        });
      })();
    </script>

    <div class="receipt-copies">
      {% for copy_label in ["Student Copy", "Office Copy"] %}
      <div class="receipt-copy">
        <div class="text-center mb-2 receipt-header">
          <img src="{{ url_for('static', filename='logo.png') }}" alt="Parekh Colleges Logo" />
          <div class="brand-title-main">The Group of Parekh Colleges - Mahuva</div>
          <div class="brand-title-sub">Managed by Shri Balvant Parekh Education Trust (SBPET)</div>
          {% if selected_program %}
            <div class="fw-bold mt-1">{{ selected_program.program_name }}</div>
          {% endif %}
          {% if semester %}
            <div class="text-muted">Semester {{ semester }}{% if show_medium %} — Medium: {{ (filters.medium or '') and filters.medium or 'Common' }}{% endif %}</div>
          {% endif %}
          <div class="small text-muted">{{ copy_label }}</div>
          {% if verified_payment and verified_payment.receipt_no %}
            <div class="mt-1">
              <span class="badge bg-light text-dark">Receipt No.: {{ verified_payment.receipt_no }}</span>
            </div>
          {% elif preview_receipt_no %}
            <div class="mt-1">
              <span class="badge bg-light text-dark">Receipt No.: {{ preview_receipt_no }}</span>
            </div>
          {% endif %}
        </div>
        {% if student %}
        <div class="receipt-student">
          <strong>Student:</strong>
          {{ ((student.student_name or '') ~ (student.father_name and (' ' ~ student.father_name) or '') ~ (student.surname and (' ' ~ student.surname) or ''))|trim }}
          {% set enr = student.enrollment_no or student.enrollment or filters.enrollment_no %}
          {% if enr %}<small>({{ enr }})</small>{% endif %}
        </div>
        {% endif %}
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Component</th>
                <th class="text-end">Amount (INR)</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
                <tr>
                  <td>{{ item.component }}</td>
                  <td class="text-end">{{ (item.amount or 0)|round(2) }}</td>
                </tr>
              {% endfor %}
              <tr>
                <th class="text-end">Total</th>
                <th class="text-end">{{ (total_amount or 0)|round(2) }}</th>
              </tr>
            </tbody>
          </table>
        </div>
        {% if bank_details or verified_payment %}
        <div class="row g-3">
          <div class="col-md-6">
            <div class="border rounded p-2">
              <div class="fw-semibold mb-2">Payment Summary</div>
              {% if verified_payment %}
                <div><strong>Status:</strong> Verified</div>
                <div><strong>UTR:</strong> {{ verified_payment.utr or '-' }}</div>
                <div><strong>Amount:</strong> ₹ {{ (verified_payment.amount or total_amount or 0)|round(2) }}</div>
                <div><strong>Verified At:</strong> {{ (verified_payment.verified_at or verified_payment.updated_at or verified_payment.created_at) }}</div>
                <div><strong>Payer Name:</strong> {{ verified_payment.payer_name or '-' }}</div>
                <div><strong>Transaction Date (Bank Credit):</strong> {{ verified_payment.bank_credit_at and verified_payment.bank_credit_at.strftime('%Y-%m-%d %H:%M') or '-' }}</div>
              {% else %}
                <div class="text-muted">No verified payment found for this receipt.</div>
              {% endif %}
            </div>
          </div>
          {% if bank_details %}
          <div class="col-md-6">
            <div class="border rounded p-2">
              <div class="fw-semibold mb-2">Bank Details</div>
              <div><strong>Account Name:</strong> {{ bank_details.account_name or bank_details.payee_display or '-' }}</div>
              <div><strong>Account Number:</strong> {{ bank_details.account_number or '-' }}</div>
              <div><strong>IFSC:</strong> {{ bank_details.ifsc_code or '-' }}</div>
              <div><strong>Bank:</strong> {{ bank_details.bank_name or '-' }}</div>
              <div><strong>Branch:</strong> {{ bank_details.branch_name or '-' }}</div>
              <div><strong>UPI ID:</strong> {{ bank_details.upi_vpa or '-' }}</div>
              {% if bank_details.qr_image_url %}
                <div class="mt-2 d-flex align-items-center gap-2">
                  <img alt="UPI QR" src="{{ bank_details.qr_image_url }}" style="height: 96px; width: auto;" />
                  <span class="text-muted small">Scan to pay via UPI</span>
                </div>
               {% elif receipt_upi_uri %}
                 <div class="mt-2 d-flex align-items-center gap-2">
                   <div class="qr-dynamic" data-uri="{{ receipt_upi_uri }}" style="height:96px;width:96px;border:1px solid #ddd;border-radius:4px;"></div>
                   <span class="text-muted small">Scan to pay via UPI</span>
                 </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>
        {% endif %}
        <div class="row mt-3">
          <div class="col-md-6 text-center">
            <div style="border-top:1px solid #333;padding-top:6px;">Clerk Signature</div>
          </div>
          <div class="col-md-6 text-center">
            <div style="border-top:1px solid #333;padding-top:6px;">Admin Signature</div>
          </div>
        </div>
        {% if loop.last %}
        <div class="mt-2 small text-muted receipt-disclaimer">
          Disclaimer: This receipt is system-generated. Payment is subject to bank realization. Please verify details and retain this document for your records.
        </div>
        {% endif %}
        <div class="text-center mb-3">
          <div class="badge text-bg-secondary">{{ copy_label }}</div>
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="mt-3 d-flex justify-content-end gap-2 no-print">
      <a class="btn btn-outline-secondary" href="{{ url_for('main.fees_structure_view', program_id=selected_program.program_id, semester=semester) }}">View Structure</a>
      <button class="btn btn-primary" onclick="window.print()">Print</button>
    </div>
    <div class="mt-3 small text-muted no-print">
      Disclaimer: This receipt is system-generated. Payment is subject to bank realization. Please verify details and retain this document for your records.
    </div>
  {% endif %}
  {% if request.args.get('auto') %}
  <script>
    // Auto print when ?auto=1 is present; useful with kiosk printing
    window.addEventListener('load', function(){
      setTimeout(function(){ try { window.print(); } catch(e) {} }, 200);
    });
  </script>
  {% endif %}
  <script>
    // Generate dynamic QR codes where static bank QR is not available
    (function(){
      try {
        var els = document.querySelectorAll('.qr-dynamic');
        if (els && els.length) {
          els.forEach(function(el){
            var uri = el && el.dataset && el.dataset.uri;
            if (uri && uri.length > 0) {
              try { new QRCode(el, { text: uri, width: 96, height: 96 }); } catch(e) {}
            }
          });
        }
      } catch(e) {}
    })();
  </script>
</div>
{% endblock %}