{% extends 'layout.html' %}
{% block content %}
<div class="container mt-4 dashboard-linear">
  <!-- Role-themed Dashboard Hero: keeps existing content below -->
  <div class="page-hero mb-3">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
      <div class="mb-2">
        {% if acting_trust %}
            <div class="h4 mb-0">{{ acting_trust.trust_name }}</div>
            <div class="small">{{ t('Managed by') }} {{ acting_trust.trust_name }}</div>
        {% else %}
            <div class="h4 mb-0">{{ t('The Group of Parekh Colleges - Mahuva') }}</div>
            <div class="small">{{ t('Managed by Shri Balvant Parekh Education Trust (SBPET)') }}</div>
        {% endif %}
      </div>
      <div class="actions d-flex gap-2 flex-wrap">
        <a class="btn btn-outline-primary btn-sm" href="{{ url_for('main.notice_board') }}">{{ t('Notices') }}</a>
        <a class="btn btn-outline-primary btn-sm" href="{{ url_for('main.module_announcements') }}">{{ t('Announcements') }}</a>
        {% if current_user.is_authenticated %}
          <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('main.dashboard', chart_semester=request.args.get('chart_semester'), chart_program_id=request.args.get('chart_program_id'), trust_id=request.args.get('trust_id')) }}">{{ t('Refresh') }}</a>
        {% endif %}
        {% if redis_active is not none %}
          {% if redis_active %}
            <span class="badge bg-success align-self-center">{{ t('Redis Active') }}</span>
          {% else %}
            <span class="badge bg-warning text-dark align-self-center">{{ t('In-memory cache') }}</span>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>

  {% if acting_trust %}
    <div class="alert alert-warning d-flex justify-content-between align-items-center mb-3 shadow-sm border-warning">
        <div>
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-shield-lock-fill fs-4 text-warning-emphasis"></i>
                <div>
                    <h5 class="mb-0 text-warning-emphasis">Acting as Admin</h5>
                    <div class="small text-muted">You are viewing this dashboard as an administrator for <strong>{{ acting_trust.trust_name }}</strong>.</div>
                </div>
            </div>
        </div>
        <div>
                    <a href="{{ url_for('main.set_trust_context', trust_id=0) }}" class="btn btn-warning">
                        <i class="bi bi-arrow-left"></i> Return to Global View
                    </a>
                </div>
    </div>
  {% endif %}

  {% if announcements and (announcements|length) > 0 %}
    {% for a in announcements %}
      <div class="alert alert-{{ a.severity or 'info' }} d-flex justify-content-between align-items-center" role="alert">
        <div>
          <strong>{{ a.title_gu if (lang_code=='gu' and a.title_gu) else a.title }}</strong>
          <div class="small">{{ a.message_gu if (lang_code=='gu' and a.message_gu) else a.message }}</div>
        </div>
        <div class="d-flex align-items-center gap-2">
          {% if current_user.is_authenticated and (current_user.role|lower in ['admin','clerk','principal','faculty']) %}
            <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.announcements_list') }}">{{ t('Manage') }}</a>
          {% endif %}
          {% if current_user.is_authenticated %}
            <form method="post" action="{{ url_for('main.announcement_dismiss', announcement_id=a.announcement_id) }}">
              <button type="submit" class="btn btn-sm btn-outline-secondary">{{ t('Dismiss') }}</button>
            </form>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  {% endif %}

  {% if notifications_vm and (notifications_vm|length) > 0 and (current_user.role|lower) == 'student' %}
    {% for n in notifications_vm %}
      {% set sev = 'danger' if (n.kind=='fee_rejected') else ('success' if (n.kind=='fee_verified') else 'info') %}
      <div class="alert alert-{{ sev }} d-flex justify-content-between align-items-center" role="alert">
        <div>
          <strong>{{ n.title }}</strong>
          {% if n.message %}<div class="small">{{ n.message }}</div>{% endif %}
        </div>
        <div class="d-flex align-items-center gap-2">
          {% if n.kind == 'fee_rejected' %}
            <a class="btn btn-sm btn-outline-danger" href="{{ n.resubmit_url or url_for('main.module_fees') }}">Resubmit Fees</a>
            <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.fees_payment_status') }}">View Status</a>
          {% elif n.kind == 'fee_verified' %}
            <a class="btn btn-sm btn-outline-success" href="{{ url_for('main.fees_payment_status') }}">View Receipt</a>
          {% endif %}
          <form method="post" action="{{ n.dismiss_post }}" class="ms-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <button type="submit" class="btn btn-sm btn-outline-secondary">Dismiss</button>
          </form>
        </div>
      </div>
    {% endfor %}
  {% endif %}
  <div class="card kpi-hero mb-3 role-{{ current_user.role|lower }}">
    <div class="card-body d-flex justify-content-between align-items-center flex-wrap">
      <div class="mb-2">
        <div class="h4 mb-0">{{ (summary.program or t('Program')) }} {{ t('Dashboard') }}</div>
        <div class="text-muted">{{ t('Academic Year:') }} {{ summary.academic_year or 'N/A' }}</div>
      </div>
      <div class="d-flex gap-3 flex-wrap">
        <div class="kpi">
          <div class="label">{{ t('Students') }}</div>
          <div class="value">{{ summary.students or 0 }}</div>
        </div>
        <div class="kpi">
          <div class="label">{{ t('Subjects') }}</div>
          <div class="value">{{ summary.subjects or 0 }}</div>
        </div>
        <div class="kpi">
          <div class="label">{{ t('Divisions') }}</div>
          <div class="value">{{ summary.divisions or 0 }}</div>
        </div>
        {% if (current_user.role|lower) in ['admin','principal'] and summary.attendance_today %}
        {% set att = summary.attendance_today %}
        <div class="kpi">
          <div class="label">{{ t('Attendance Today') }}</div>
          <div class="value">
            {% if att.total %}
              {{ ((att.present + att.late) * 100) // att.total }}%
            {% else %}
              {{ t('N/A') }}
            {% endif %}
          </div>
        </div>
        <div class="kpi">
          <div class="label">{{ t('Missing Mobile') }}</div>
          <div class="value">{{ summary.students_missing_mobile or 0 }}</div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  {% if (current_user.role|lower) == 'student' and student_view %}
  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header card-header-standard"><div class="card-title">{{ t('My Attendance') }}</div></div>
        <div class="card-body">
          {% if student_view.attendance %}
            <div class="display-6 mb-1">{{ student_view.attendance.overall_pct }}%</div>
            <div class="small text-muted">{{ t('Present') }} {{ student_view.attendance.present }} / {{ student_view.attendance.total }}</div>
          {% else %}
            <div class="text-muted small">{{ t('No attendance records yet.') }}</div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header card-header-standard"><div class="card-title">{{ t('My Fees') }}</div></div>
        <div class="card-body">
          {% if student_view.fees %}
            <div class="small mb-1">{{ t('Total Due') }}: {{ student_view.fees.total_due }}</div>
            <div class="small mb-1">{{ t('Total Paid') }}: {{ student_view.fees.total_paid }}</div>
            <div class="h5 mb-0">{{ t('Pending') }}: {{ student_view.fees.pending }}</div>
          {% else %}
            <div class="text-muted small">{{ t('No fee records yet.') }}</div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header card-header-standard"><div class="card-title">{{ t('My GPA') }}</div></div>
        <div class="card-body">
          {% if student_view.gpa and student_view.gpa.avg_gpa %}
            <div class="display-6 mb-1">{{ student_view.gpa.avg_gpa }}</div>
            <div class="small text-muted">{{ t('Average across recorded subjects') }}</div>
          {% else %}
            <div class="text-muted small">{{ t('No grade records yet.') }}</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <div class="row g-3 mb-3">
    <div class="col-md-8">
      <div class="card h-100">
        <div class="card-header card-header-standard"><div class="card-title">{{ t('Subjects To Watch') }}</div></div>
        <div class="card-body">
          {% if student_view.low_attendance_subjects and student_view.low_attendance_subjects|length > 0 %}
            <ul class="mb-0">
              {% for s in student_view.low_attendance_subjects %}
                <li>{{ s.subject }} – {{ s.attendance }}%</li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-muted small">{{ t('No subjects below 75% attendance.') }}</div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header card-header-standard"><div class="card-title">{{ t('My Results') }}</div></div>
        <div class="card-body">
          {% if student_view.results %}
            <div class="mb-1 fw-semibold">{{ student_view.results.scheme_name }}</div>
            {% if student_view.results.status %}
              <div class="small mb-1">{{ t('Status') }}: {{ student_view.results.status }}</div>
            {% endif %}
            {% if student_view.results.sgpa %}
              <div class="small mb-2">{{ t('SGPA') }}: {{ student_view.results.sgpa }}</div>
            {% endif %}
            <a href="{{ url_for('exams.student_result_view') }}" class="btn btn-sm btn-outline-primary">{{ t('View Full Results') }}</a>
          {% else %}
            <div class="text-muted small mb-2">{{ t('No exam results yet.') }}</div>
            <a href="{{ url_for('exams.student_result_view') }}" class="btn btn-sm btn-outline-secondary">{{ t('Open Results Page') }}</a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Role-Based Infographics placed right after hero and above modules grid -->
  <div class="mt-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0">{{ t('Role-Based Infographics') }}</h5>
      <div class="d-flex align-items-center gap-3">
        {% if (current_user.role|lower) in ['principal','clerk'] and semester_list %}
        <form method="get" action="{{ url_for('main.dashboard') }}" class="d-flex align-items-center gap-2">
          <label class="small text-muted mb-0" for="chartSemester">{{ t('Semester') }}</label>
          <select id="chartSemester" name="chart_semester" class="form-select form-select-sm" onchange="this.form.submit()">
            <option value="">{{ t('All') }}</option>
            {% for sem in semester_list %}
              {% set sel_sem = request.args.get('chart_semester') %}
              <option value="{{ sem }}" {% if sel_sem and (sel_sem|int)==sem %}selected{% endif %}>{{ sem }}</option>
            {% endfor %}
          </select>
        </form>
        {% endif %}
        {% if (current_user.role|lower) == 'principal' and subject_list and (subject_list|length) > 0 %}
        <form method="get" action="{{ url_for('main.dashboard') }}" class="d-flex align-items-center gap-2">
          <label class="small text-muted mb-0" for="chartSubject">{{ t('Subject') }}</label>
          <select id="chartSubject" name="chart_subject_id" class="form-select form-select-sm" onchange="this.form.submit()">
            <option value="">{{ t('All') }}</option>
            {% set sel_subj = request.args.get('chart_subject_id') %}
            {% for s in subject_list %}
              <option value="{{ s.subject_id }}" {% if sel_subj and (sel_subj|int)==s.subject_id %}selected{% endif %}>{{ s.subject_name }}</option>
            {% endfor %}
          </select>
          {% if request.args.get('chart_semester') %}
            <input type="hidden" name="chart_semester" value="{{ request.args.get('chart_semester') }}" />
          {% endif %}
        </form>
        {% endif %}
        {% if (current_user.role|lower) == 'admin' and program_list and (program_list|length) > 1 %}
        <form method="get" action="{{ url_for('main.dashboard') }}" class="d-flex align-items-center gap-2">
          <label class="small text-muted mb-0" for="chartProgram">{{ t('Program') }}</label>
          <select id="chartProgram" name="chart_program_id" class="form-select form-select-sm" onchange="this.form.submit()">
            <option value="">{{ t('All') }}</option>
            {% set sel_pid = request.args.get('chart_program_id') %}
            {% for p in program_list %}
              <option value="{{ p.program_id }}" {% if sel_pid and (sel_pid|int)==p.program_id %}selected{% endif %}>{{ p.program_name }}</option>
            {% endfor %}
          </select>
          {% if request.args.get('chart_semester') %}
            <input type="hidden" name="chart_semester" value="{{ request.args.get('chart_semester') }}" />
          {% endif %}
        </form>
        {% endif %}
      </div>
    </div>

    {% if (current_user.role|lower) == 'admin' %}
      <div class="row row-cols-1 row-cols-md-2 g-3">
        <div class="col">
          <div class="card">
            <div class="card-header card-header-standard"><div class="card-title">{{ t('Students by Program') }}</div></div>
            <div class="card-body"><canvas id="chartStudentsProgram" height="100"></canvas></div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <div class="card-header card-header-standard"><div class="card-title">{{ t('Fees Collection by Program') }}</div></div>
            <div class="card-body"><canvas id="chartFeesProgram" height="140"></canvas></div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <div class="card-header card-header-standard"><div class="card-title">{{ t('Annual Income vs Expenses') }}</div></div>
            <div class="card-body"><canvas id="chartIncomeExpensesAnnual" height="140"></canvas></div>
          </div>
        </div>
        <div class="col">
          <div class="card h-100">
            <div class="card-header card-header-standard"><div class="card-title">{{ t('Program Summary (Students & Diversity)') }}</div></div>
            <div class="card-body">
              {% if charts.category_gender_by_program %}
                {% set grand = namespace(male=0, female=0, other=0, total=0, reserved=0) %}
                <div class="table-responsive">
                  <table class="table table-sm align-middle mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>{{ t('Program') }}</th>
                        <th class="text-end">{{ t('Total') }}</th>
                        <th class="text-end">{{ t('Boys') }}</th>
                        <th class="text-end">{{ t('Girls') }}</th>
                        <th class="text-end d-none d-sm-table-cell">{{ t('Other') }}</th>
                        <th class="text-end d-none d-md-table-cell">{{ t('% Girls') }}</th>
                        <th class="text-end d-none d-md-table-cell">{{ t('% Reserved') }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for pg in charts.category_gender_by_program %}
                        {% set prog = namespace(male=0, female=0, other=0, total=0, reserved=0) %}
                        {% for cat, vals in pg.categories.items() %}
                          {% set c_male = vals.male|default(0) %}
                          {% set c_female = vals.female|default(0) %}
                          {% set c_other = vals.other|default(0) %}
                          {% set c_total = c_male + c_female + c_other %}
                          {% set prog.male = prog.male + c_male %}
                          {% set prog.female = prog.female + c_female %}
                          {% set prog.other = prog.other + c_other %}
                          {% set prog.total = prog.total + c_total %}
                          {% set cat_label = (cat or 'Category Missing')|trim|upper %}
                          {% if cat_label not in ['GENERAL', 'CATEGORY MISSING'] %}
                            {% set prog.reserved = prog.reserved + c_total %}
                          {% endif %}
                        {% endfor %}
                        {% set grand.male = grand.male + prog.male %}
                        {% set grand.female = grand.female + prog.female %}
                        {% set grand.other = grand.other + prog.other %}
                        {% set grand.total = grand.total + prog.total %}
                        {% set grand.reserved = grand.reserved + prog.reserved %}
                        {% if prog.total > 0 %}
                          {% set pct_girls = (prog.female * 100.0) / prog.total %}
                          {% set pct_reserved = (prog.reserved * 100.0) / prog.total %}
                        {% else %}
                          {% set pct_girls = 0 %}
                          {% set pct_reserved = 0 %}
                        {% endif %}
                        <tr>
                          <td>{{ pg.program }}</td>
                          <td class="text-end">{{ prog.total }}</td>
                          <td class="text-end">{{ prog.male }}</td>
                          <td class="text-end">{{ prog.female }}</td>
                          <td class="text-end d-none d-sm-table-cell">{{ prog.other }}</td>
                          <td class="text-end d-none d-md-table-cell">{{ "%.1f"|format(pct_girls) }}%</td>
                          <td class="text-end d-none d-md-table-cell">{{ "%.1f"|format(pct_reserved) }}%</td>
                        </tr>
                      {% endfor %}
                      {% if grand.total > 0 %}
                        {% set g_pct_girls = (grand.female * 100.0) / grand.total %}
                        {% set g_pct_reserved = (grand.reserved * 100.0) / grand.total %}
                      {% else %}
                        {% set g_pct_girls = 0 %}
                        {% set g_pct_reserved = 0 %}
                      {% endif %}
                      <tr class="table-secondary fw-semibold">
                        <td>{{ t('All Programs') }}</td>
                        <td class="text-end">{{ grand.total }}</td>
                        <td class="text-end">{{ grand.male }}</td>
                        <td class="text-end">{{ grand.female }}</td>
                        <td class="text-end d-none d-sm-table-cell">{{ grand.other }}</td>
                        <td class="text-end d-none d-md-table-cell">{{ "%.1f"|format(g_pct_girls) }}%</td>
                        <td class="text-end d-none d-md-table-cell">{{ "%.1f"|format(g_pct_reserved) }}%</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="text-muted small">{{ t('No student data available.') }}</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      <div class="row g-3 mt-2">
        <div class="col">
          <div class="card">
            <div class="card-header card-header-standard"><div class="card-title">{{ t('Category-wise Gender by Program') }}</div></div>
            <div class="card-body">
              {% if charts.category_gender_by_program %}
                <div class="table-responsive" style="max-height: 360px; overflow-y: auto;">
                  <table class="table table-sm align-middle mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>{{ t('Program') }}</th>
                        <th>{{ t('Category') }}</th>
                        <th class="text-end">{{ t('Boys') }}</th>
                        <th class="text-end">{{ t('Girls') }}</th>
                        <th class="text-end d-none d-sm-table-cell">{{ t('Other') }}</th>
                        <th class="text-end">{{ t('Total') }}</th>
                        <th class="text-end d-none d-md-table-cell">{{ t('% Girls') }}</th>
                        <th class="text-end d-none d-md-table-cell">{{ t('% of Program') }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for pg in charts.category_gender_by_program %}
                        {% set items = pg.categories.items()|list %}
                        {% if items %}
                          {% set prog_tot = namespace(total=0, male=0, female=0, other=0) %}
                          {% for cat, vals in items %}
                            {% set c_male = vals.male|default(0) %}
                            {% set c_female = vals.female|default(0) %}
                            {% set c_other = vals.other|default(0) %}
                            {% set c_total = c_male + c_female + c_other %}
                            {% set prog_tot.total = prog_tot.total + c_total %}
                            {% set prog_tot.male = prog_tot.male + c_male %}
                            {% set prog_tot.female = prog_tot.female + c_female %}
                            {% set prog_tot.other = prog_tot.other + c_other %}
                          {% endfor %}
                          {% for cat, vals in items|sort %}
                            {% set c_male = vals.male|default(0) %}
                            {% set c_female = vals.female|default(0) %}
                            {% set c_other = vals.other|default(0) %}
                            {% set c_total = c_male + c_female + c_other %}
                            {% if prog_tot.total > 0 %}
                              {% set pct_girls = (c_female * 100.0) / c_total if c_total > 0 else 0 %}
                              {% set pct_of_prog = (c_total * 100.0) / prog_tot.total %}
                            {% else %}
                              {% set pct_girls = 0 %}
                              {% set pct_of_prog = 0 %}
                            {% endif %}
                            <tr>
                              <td>{{ pg.program }}</td>
                              <td>{{ cat or 'Category Missing' }}</td>
                              <td class="text-end">{{ c_male }}</td>
                              <td class="text-end">{{ c_female }}</td>
                              <td class="text-end d-none d-sm-table-cell">{{ c_other }}</td>
                              <td class="text-end">{{ c_total }}</td>
                              <td class="text-end d-none d-md-table-cell">{{ "%.1f"|format(pct_girls) }}%</td>
                              <td class="text-end d-none d-md-table-cell">{{ "%.1f"|format(pct_of_prog) }}%</td>
                            </tr>
                          {% endfor %}
                          {% if prog_tot.total > 0 %}
                            {% set prog_pct_girls = (prog_tot.female * 100.0) / prog_tot.total %}
                          {% else %}
                            {% set prog_pct_girls = 0 %}
                          {% endif %}
                          <tr class="table-secondary">
                            <td class="fw-semibold">{{ pg.program }}</td>
                            <td class="fw-semibold">{{ t('Total') }}</td>
                            <td class="text-end fw-semibold">{{ prog_tot.male }}</td>
                            <td class="text-end fw-semibold">{{ prog_tot.female }}</td>
                            <td class="text-end fw-semibold d-none d-sm-table-cell">{{ prog_tot.other }}</td>
                            <td class="text-end fw-semibold">{{ prog_tot.total }}</td>
                            <td class="text-end fw-semibold d-none d-md-table-cell">{{ "%.1f"|format(prog_pct_girls) }}%</td>
                            <td class="text-end fw-semibold d-none d-md-table-cell">100%</td>
                          </tr>
                        {% endif %}
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="text-muted small">{{ t('No student data available.') }}</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      <div class="row g-3 mt-2">
        <div class="col-md-3">
          <div class="card h-100">
            <div class="card-header card-header-standard"><div class="card-title">{{ t('Programs With No Students') }}</div></div>
            <div class="card-body">
              {% if charts.admin_insights and charts.admin_insights.no_students_programs %}
                <ul class="mb-0">
                  {% for name in charts.admin_insights.no_students_programs %}
                    <li>{{ name }}</li>
                  {% endfor %}
                </ul>
              {% else %}
                <div class="text-muted small">{{ t('All programs have students.') }}</div>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card h-100">
            <div class="card-header card-header-standard"><div class="card-title">{{ t('Programs With No Staff') }}</div></div>
            <div class="card-body">
              {% if charts.admin_insights and charts.admin_insights.no_staff_programs %}
                <ul class="mb-0">
                  {% for name in charts.admin_insights.no_staff_programs %}
                    <li>{{ name }}</li>
                  {% endfor %}
                </ul>
              {% else %}
                <div class="text-muted small">{{ t('All programs have assigned staff.') }}</div>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card h-100">
            <div class="card-header card-header-standard"><div class="card-title">{{ t('Programs With No Timetable') }}</div></div>
            <div class="card-body">
              {% if charts.admin_insights and charts.admin_insights.no_timetable_programs %}
                <ul class="mb-0">
                  {% for name in charts.admin_insights.no_timetable_programs %}
                    <li>{{ name }}</li>
                  {% endfor %}
                </ul>
              {% else %}
                <div class="text-muted small">{{ t('All programs have a timetable configured.') }}</div>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card h-100">
            <div class="card-header card-header-standard"><div class="card-title">{{ t('Data Quality') }}</div></div>
            <div class="card-body">
              <div class="small mb-1">{{ t('Students without mobile number:') }} {{ summary.students_missing_mobile }}</div>
              <div class="small mb-1">{{ t('Students without user account:') }} {{ summary.students_without_user }}</div>
              <div class="small">
                <a href="{{ url_for('main.students_missing_category_report') }}" class="text-decoration-none">
                  {{ t('Students with Category Missing:') }} {{ summary.students_missing_category }}
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% elif (current_user.role|lower) in ['principal','clerk'] %}
      <div class="mb-3 d-flex flex-wrap gap-2">
        {% if (current_user.role|lower) == 'principal' %}
          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('main.students_semester_promotion') }}">{{ t('Semester Promotion') }}</a>
          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('main.attendance_report_admin') }}">{{ t('Attendance Report') }}</a>
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.module_fees') }}">{{ t('Fees Overview') }}</a>
        {% elif (current_user.role|lower) == 'clerk' %}
          {% if not fees_disabled %}
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('main.fees_entry') }}">{{ t('Collect Fees') }}</a>
          {% endif %}
          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('main.fees_payment_status') }}">{{ t('Payment Status') }}</a>
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.students') }}">{{ t('Students') }}</a>
        {% endif %}
      </div>
      <div class="row g-3 mb-2">
        <div class="col-md-4">
          <div class="card h-100">
            <div class="card-header card-header-standard"><div class="card-title">{{ t('Students by Semester (My Program)') }}</div></div>
            <div class="card-body">
              {% if charts.students_by_semester %}
                <div class="table-responsive">
                  <table class="table table-sm align-middle mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>{{ t('Sem') }}</th>
                        <th class="text-end">{{ t('Students') }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for idx in range(charts.students_by_semester.labels|length) %}
                        <tr>
                          <td>{{ charts.students_by_semester.labels[idx] }}</td>
                          <td class="text-end">{{ charts.students_by_semester.data[idx] }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="text-muted small">{{ t('No student data available.') }}</div>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card h-100">
            <div class="card-header card-header-standard"><div class="card-title">{{ t('Fees by Semester (My Program)') }}</div></div>
            <div class="card-body">
              {% if charts.fees_by_semester %}
                <div class="table-responsive">
                  <table class="table table-sm align-middle mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>{{ t('Sem') }}</th>
                        <th class="text-end">{{ t('Amount (INR)') }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for idx in range(charts.fees_by_semester.labels|length) %}
                        <tr>
                          <td>{{ charts.fees_by_semester.labels[idx] }}</td>
                          <td class="text-end">{{ charts.fees_by_semester.data[idx] }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="text-muted small">{{ t('No fee data available.') }}</div>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card h-100">
            <div class="card-header card-header-standard"><div class="card-title">{{ t('Gender by Semester (My Program)') }}</div></div>
            <div class="card-body">
              {% if charts.gender_by_semester %}
                <div class="table-responsive">
                  <table class="table table-sm align-middle mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>{{ t('Sem') }}</th>
                        <th class="text-end">{{ t('Boys') }}</th>
                        <th class="text-end">{{ t('Girls') }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for idx in range(charts.gender_by_semester.labels|length) %}
                        <tr>
                          <td>{{ charts.gender_by_semester.labels[idx] }}</td>
                          <td class="text-end">{{ charts.gender_by_semester.male[idx] }}</td>
                          <td class="text-end">{{ charts.gender_by_semester.female[idx] }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="text-muted small">{{ t('No gender data available.') }}</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      <div class="row g-3">
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header card-header-standard"><div class="card-title">{{ t('Attendance Trend (Last 7 Days)') }}</div></div>
            <div class="card-body">
              <canvas id="chartAttendanceWeek" height="120"></canvas>
            </div>
          </div>
        </div>
        {% if (current_user.role|lower) == 'principal' %}
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header card-header-standard"><div class="card-title">{{ t('Results Snapshot (Avg GPA by Subject)') }}</div></div>
            <div class="card-body">
              {% if charts.subject_results and charts.subject_results.labels %}
                <div class="table-responsive">
                  <table class="table table-sm align-middle mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>{{ t('Subject') }}</th>
                        <th class="text-end">{{ t('Avg GPA') }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for idx in range(charts.subject_results.labels|length) %}
                        <tr>
                          <td>{{ charts.subject_results.labels[idx] }}</td>
                          <td class="text-end">{{ charts.subject_results.data[idx] }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="text-muted small">{{ t('No result data available.') }}</div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endif %}
      </div>
      {% if clerk_fees and (current_user.role|lower) == 'clerk' %}
      <div class="row g-3 mt-2">
        <div class="col-md-4">
          <div class="card h-100">
            <div class="card-header card-header-standard"><div class="card-title">{{ t("Today's Collections") }}</div></div>
            <div class="card-body">
              <div class="h5 mb-1">{{ clerk_fees.today_amount }}</div>
              <div class="small text-muted">{{ t('Transactions:') }} {{ clerk_fees.today_tx_count }}</div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card h-100">
            <div class="card-header card-header-standard"><div class="card-title">{{ t('Pending Verifications') }}</div></div>
            <div class="card-body">
              <div class="h5 mb-0">{{ clerk_fees.pending_count }}</div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card h-100">
            <div class="card-header card-header-standard"><div class="card-title">{{ t('Rejected Payments') }}</div></div>
            <div class="card-body">
              <div class="h5 mb-0">{{ clerk_fees.rejected_count }}</div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    {% elif (current_user.role|lower) == 'faculty' %}
      <div class="alert alert-info text-center my-5 shadow-sm">
        <h4 class="alert-heading"><i class="bi bi-info-circle me-2"></i>{{ t('Faculty Dashboard') }}</h4>
        <p class="lead mb-4">{{ t('You are currently viewing the generic dashboard. Please proceed to your dedicated faculty dashboard.') }}</p>
        <a href="{{ url_for('faculty.dashboard') }}" class="btn btn-primary btn-lg">
          <i class="bi bi-speedometer2 me-2"></i> {{ t('Go to Faculty Dashboard') }}
        </a>
      </div>
    {% endif %}

    
  </div>

  {% if summary.att_risk_overview and (current_user.role|lower in ['admin','principal']) %}
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div class="h6 mb-0">{{ t('Academic Health & At-Risk Attendance') }}</div>
      <a href="{{ url_for('main.attendance_report_admin') }}" class="btn btn-sm btn-outline-secondary">
        {{ t('Open Attendance Report') }}
      </a>
    </div>
    <div class="card-body">
      <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-3">
        <div class="col">
          <div class="text-muted small">{{ t('7-day Avg Present %') }}</div>
          <div class="h4 mb-0">{{ summary.att_risk_overview.avg_present_pct }}%</div>
        </div>
        <div class="col">
          <div class="text-muted small">{{ t('7-day Avg Absent %') }}</div>
          <div class="h4 mb-0">{{ summary.att_risk_overview.avg_absent_pct }}%</div>
        </div>
        <div class="col">
          <div class="text-muted small">{{ t('Days below 75% (last 7 days)') }}</div>
          <div class="h4 mb-0">
            {{ summary.att_risk_overview.risk_days }}
            <span class="small text-muted">/ {{ summary.att_risk_overview.days_total }}</span>
          </div>
        </div>
        <div class="col">
          <div class="text-muted small">{{ t('Today Attendance (P+L)') }}</div>
          {% if summary.attendance_today %}
            {% set att = summary.attendance_today %}
            {% if att.total %}
              <div class="h4 mb-0">{{ ((att.present + att.late) * 100) // att.total }}%</div>
            {% else %}
              <div class="h4 mb-0">{{ t('N/A') }}</div>
            {% endif %}
          {% else %}
            <div class="h4 mb-0">{{ t('N/A') }}</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  {% if (current_user.role|lower in ['admin','principal']) and not fees_disabled and summary.fees_overview %}
  {% set fo = summary.fees_overview %}
  {% set fr = summary.fees_risk %}
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div class="h6 mb-0">{{ t('Fees & Finance Overview') }}</div>
      <a href="{{ url_for('main.module_fees') }}" class="btn btn-sm btn-outline-secondary">
        {{ t('Open Fees Module') }}
      </a>
    </div>
    <div class="card-body">
      <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-3 mb-3">
        <div class="col">
          <div class="text-muted small">{{ t('Total Due (All Records)') }}</div>
          <div class="h4 mb-0">₹ {{ fo.total_due|round(2) }}</div>
        </div>
        <div class="col">
          <div class="text-muted small">{{ t('Total Collected') }}</div>
          <div class="h4 mb-0">₹ {{ fo.total_collected|round(2) }}</div>
        </div>
        <div class="col">
          <div class="text-muted small">{{ t('Total Outstanding') }}</div>
          <div class="h4 mb-0">₹ {{ fo.total_outstanding|round(2) }}</div>
        </div>
        <div class="col">
          <div class="text-muted small">{{ t('Collection %') }}</div>
          <div class="h4 mb-0">{{ fo.collection_pct }}%</div>
        </div>
      </div>
      {% if fr %}
      <div class="small text-muted">
        {{ t('Risk Snapshot') }}:
        {{ t('Unpaid fee records') }}: {{ fr.none }},
        {{ t('Partial payments') }}: {{ fr.partial }},
        {{ t('Fully paid') }}: {{ fr.full }}
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  {% if current_user.is_authenticated and (current_user.role|lower in ['admin','principal']) %}
  <div class="modules-grid mb-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div class="h6 mb-0">{{ t('Admin Modules') }}</div>
        <div class="d-flex align-items-center gap-2">
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.module_admin') }}">{{ t('Open Admin Center') }}</a>
          <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#adminModules" aria-expanded="false" aria-controls="adminModules">
            {{ t('Show / Hide') }}
          </button>
        </div>
      </div>
      <div id="adminModules" class="collapse">
        <div class="card-body">
          <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">
            <div class="col">
              <div class="module-card card">
                <a class="stretched-link" href="{{ url_for('main.module_announcements') }}" aria-label="Announcements"></a>
                <div class="card-body d-flex align-items-center gap-3">
                  <span class="module-icon"><i class="bi bi-megaphone"></i></span>
                  <div>
                    <div class="h6 mb-0">{{ t('Announcements') }}</div>
                    <div class="small text-muted">{{ t('Create and publish alerts') }}</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col">
              <div class="module-card card">
                <a class="stretched-link" href="{{ url_for('main.module_attendance') }}" aria-label="Attendance"></a>
                <div class="card-body d-flex align-items-center gap-3">
                  <span class="module-icon"><i class="bi bi-calendar-check"></i></span>
                  <div>
                    <div class="h6 mb-0">{{ t('Attendance') }}</div>
                    <div class="small text-muted">{{ t('Mark, view, and report') }}</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col">
              <div class="module-card card">
                <a class="stretched-link" href="{{ url_for('main.module_students') }}" aria-label="Students"></a>
                <div class="card-body d-flex align-items-center gap-3">
                  <span class="module-icon"><i class="bi bi-people"></i></span>
                  <div>
                    <div class="h6 mb-0">{{ t('Students') }}</div>
                    <div class="small text-muted">{{ t('Manage student records') }}</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col">
              <div class="module-card card">
                <a class="stretched-link" href="{{ url_for('main.module_subjects') }}" aria-label="Subjects"></a>
                <div class="card-body d-flex align-items-center gap-3">
                  <span class="module-icon"><i class="bi bi-journal-bookmark"></i></span>
                  <div>
                    <div class="h6 mb-0">{{ t('Subjects') }}</div>
                    <div class="small text-muted">{{ t('Configure and assign') }}</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col">
              <div class="module-card card">
                <a class="stretched-link" href="{{ url_for('main.materials_hub') }}" aria-label="Materials"></a>
                <div class="card-body d-flex align-items-center gap-3">
                  <span class="module-icon"><i class="bi bi-folder2"></i></span>
                  <div>
                    <div class="h6 mb-0">{{ t('Materials') }}</div>
                    <div class="small text-muted">{{ t('Share and manage') }}</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col">
              <div class="module-card card">
                <a class="stretched-link" href="{{ url_for('main.module_faculty') }}" aria-label="Staff"></a>
                <div class="card-body d-flex align-items-center gap-3">
                  <span class="module-icon"><i class="bi bi-person-badge"></i></span>
                  <div>
                    <div class="h6 mb-0">{{ t('Staff') }}</div>
                    <div class="small text-muted">{{ t('Profiles and assignments') }}</div>
                  </div>
                </div>
              </div>
            </div>

            {% if (current_user.role|lower) in ['admin','principal','clerk'] %}
            <div class="col">
              <div class="module-card card">
                <a class="stretched-link" href="{{ url_for('main.module_divisions') }}" aria-label="Divisions"></a>
                <div class="card-body d-flex align-items-center gap-3">
                  <span class="module-icon"><i class="bi bi-diagram-3"></i></span>
                  <div>
                    <div class="h6 mb-0">{{ t('Divisions') }}</div>
                    <div class="small text-muted">{{ t('Semesters and batches') }}</div>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}

            {% if not fees_disabled and (current_user.role|lower) in ['admin','principal','clerk'] %}
            <div class="col">
              <div class="module-card card">
                {% if (current_user.role|lower) == 'clerk' %}
                  <a class="stretched-link" href="{{ url_for('main.fees_entry') }}" aria-label="Fees"></a>
                {% else %}
                  <a class="stretched-link" href="{{ url_for('main.module_fees') }}" aria-label="Fees"></a>
                {% endif %}
                <div class="card-body d-flex align-items-center gap-3">
                  <span class="module-icon"><i class="bi bi-cash-coin"></i></span>
                  <div>
                    <div class="h6 mb-0">{{ t('Fees Module') }}</div>
                    <div class="small text-muted">{{ t('Collection and reports') }}</div>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}

            <div class="col">
              <div class="module-card card">
                <a class="stretched-link" href="{{ url_for('main.programs_list') }}" aria-label="Programs"></a>
                <div class="card-body d-flex align-items-center gap-3">
                  <span class="module-icon"><i class="bi bi-mortarboard"></i></span>
                  <div>
                    <div class="h6 mb-0">{{ t('Programs') }}</div>
                    <div class="small text-muted">{{ t('Create and manage programs') }}</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col">
              <div class="module-card card">
                <a class="stretched-link" href="{{ url_for('main.users_list') }}" aria-label="Accounts"></a>
                <div class="card-body d-flex align-items-center gap-3">
                  <span class="module-icon"><i class="bi bi-people"></i></span>
                  <div>
                    <div class="h6 mb-0">{{ t('Manage Accounts') }}</div>
                    <div class="small text-muted">{{ t('Create and manage accounts') }}</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col">
              <div class="module-card card">
                <a class="stretched-link" href="{{ url_for('main.module_admin') }}" aria-label="Admin"></a>
                <div class="card-body d-flex align-items-center gap-3">
                  <span class="module-icon"><i class="bi bi-sliders"></i></span>
                  <div>
                    <div class="h6 mb-0">{{ t('Admin Module') }}</div>
                    <div class="small text-muted">{{ t('Configuration and tools') }}</div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Post-metrics cards removed to avoid duplication -->
  
<script id="attWeekData" type="application/json">{{ summary.att_week_chart | tojson | safe }}</script>
<script id="chartsData" type="application/json">{{ charts | tojson | safe }}</script>
<script id="chartsConfig" type="application/json">{{ {"isAdmin": is_admin, "isPrincipal": is_principal, "isFaculty": is_faculty} | tojson | safe }}</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/cal-heatmap@4.2.3/dist/cal-heatmap.min.js"></script>
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/cal-heatmap@4.2.3/dist/plugins/Tooltip.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/cal-heatmap@4.2.3/dist/cal-heatmap.css">
<script>
  (function(){
    const charts = JSON.parse(document.getElementById('chartsData').textContent);
    const cfg = JSON.parse(document.getElementById('chartsConfig').textContent);
    const isAdmin = !!cfg.isAdmin;
    const isPrincipal = !!cfg.isPrincipal;
    const isFaculty = !!cfg.isFaculty;
    const attWeekEl = document.getElementById('attWeekData');
    let attWeek = null;
    if (attWeekEl) {
      try {
        attWeek = JSON.parse(attWeekEl.textContent);
      } catch (e) {
        attWeek = null;
      }
    }
     
    // Render Heatmap for Principal
    if (isPrincipal && charts && charts.attendance_heatmap) {
        const cal = new CalHeatmap();
        // Convert timestamp keys to numeric
        const rawData = charts.attendance_heatmap;
        const data = [];
        for (const [ts, val] of Object.entries(rawData)) {
            data.push({ date: parseInt(ts) * 1000, value: val });
        }
        
        cal.paint({
            itemSelector: "#cal-heatmap",
            domain: { type: "month" },
            subDomain: { type: "day" },
            date: { start: new Date(new Date().setMonth(new Date().getMonth() - 5)) },
            range: 6,
            data: { source: data, x: 'date', y: 'value' },
            scale: { color: { type: 'linear', range: ['#e6f2ff', '#004085'], domain: [0, 100] } },
            theme: "light"
        }, [
            [
                Tooltip,
                {
                    text: function (date, value, dayRect) {
                        if (value === null) return "";
                        const dateObj = new Date(date);
                        const ts = Math.floor(dateObj.getTime() / 1000);
                        return `${value}% Attendance`;
                    },
                },
            ],
        ]);
    }

    // Render Heatmap for Faculty (absent % across assigned classes)
    if (isFaculty && charts && charts.faculty_attendance_heatmap) {
        const cal = new CalHeatmap();
        // Backend now returns { heatmap: {...}, details: {...} }
        // We need to handle both legacy format (direct dict) and new format
        let rawData = charts.faculty_attendance_heatmap;
        let details = {};
        
        if (rawData.heatmap) {
            details = rawData.details || {};
            rawData = rawData.heatmap;
        }

        const data = [];
        for (const [ts, val] of Object.entries(rawData)) {
            data.push({ date: parseInt(ts) * 1000, value: val });
        }
        
        cal.paint({
            itemSelector: "#cal-heatmap-faculty",
            domain: { type: "month" },
            subDomain: { type: "day" },
            date: { start: new Date(new Date().setMonth(new Date().getMonth() - 5)) },
            range: 6,
            data: { source: data, x: 'date', y: 'value' },
            scale: { color: { type: 'linear', range: ['#f8d7da', '#842029'], domain: [0, 100] } },
            theme: "light"
        }, [
            [
                Tooltip,
                {
                    text: function (date, value, dayRect) {
                        if (value === null) return "";
                        // Handle date being either a timestamp (number) or Date object
                        const dateObj = new Date(date);
                        const ts = Math.floor(dateObj.getTime() / 1000);
                        const detailText = details[ts] ? `\n${details[ts]}` : "";
                        return `${value}% Absent${detailText}`;
                    },
                },
            ],
        ]);
    }

    // Admin charts
    if (isAdmin && charts) {
      // Students by Program (pie)
      const el1 = document.getElementById('chartStudentsProgram');
      if (el1 && charts.students_by_program) {
        const labels = charts.students_by_program.map(x=>x.label);
        const data = charts.students_by_program.map(x=>x.value);
        new Chart(el1, {
          type: 'pie',
          data: { labels, datasets: [{ data, backgroundColor: ['#0d6efd','#6f42c1','#198754','#fd7e14','#20c997','#6610f2'] }] },
          options: { responsive:true, plugins:{ legend:{ position:'bottom' } } }
        });
      }
      // Fees by Program (bar)
      const el2 = document.getElementById('chartFeesProgram');
      if (el2 && charts.fees_by_program) {
        const labels = charts.fees_by_program.map(x=>x.label);
        const data = charts.fees_by_program.map(x=>x.value);
        new Chart(el2, {
          type: 'bar',
          data: { labels, datasets: [{ label:'Amount (INR)', data, backgroundColor:'#0d6efd' }] },
          options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
        });
      }
      // Staff by Program (bar)
      const el3 = document.getElementById('chartStaffProgram');
      if (el3 && charts.staff_by_program) {
        const labels = charts.staff_by_program.map(x=>x.label);
        const data = charts.staff_by_program.map(x=>x.value);
        new Chart(el3, {
          type: 'bar',
          data: { labels, datasets: [{ label:'Staff', data, backgroundColor:'#198754' }] },
          options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, precision:0 } } }
        });
      }
      // Annual Income vs Expenses (bar)
      const el4 = document.getElementById('chartIncomeExpensesAnnual');
      if (el4 && charts.income_vs_expenses) {
        const labels = charts.income_vs_expenses.labels;
        const income = charts.income_vs_expenses.income;
        const expenses = charts.income_vs_expenses.expenses;
        new Chart(el4, {
          type: 'bar',
          data: { labels, datasets: [
            { label:'Income', data: income, backgroundColor:'#20c997' },
            { label:'Expenses', data: expenses, backgroundColor:'#dc3545' }
          ] },
          options: { responsive:true, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true } } }
        });
      }
    }

    // Principal/Clerk charts
    if (!isAdmin && charts) {
      const elWeek = document.getElementById('chartAttendanceWeek');
      if (elWeek && attWeek && attWeek.labels && attWeek.labels.length) {
        new Chart(elWeek, {
          type: 'line',
          data: {
            labels: attWeek.labels,
            datasets: [
              {
                label: 'Present %',
                data: attWeek.present_pct,
                borderColor: '#198754',
                backgroundColor: 'rgba(25,135,84,0.1)',
                tension: 0.3
              },
              {
                label: 'Absent %',
                data: attWeek.absent_pct,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220,53,69,0.1)',
                tension: 0.3
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: function(ctx) {
                    return ctx.dataset.label + ': ' + ctx.parsed.y + '%';
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100
              }
            }
          }
        });
      }
      // Subject Results (principal only)
      if (isPrincipal && charts.subject_results) {
        const el8 = document.getElementById('chartSubjectResults');
        if (el8) {
          new Chart(el8, {
            type: 'bar',
            data: { labels: charts.subject_results.labels, datasets: [{ label:'Avg GPA', data: charts.subject_results.data, backgroundColor:'#6f42c1' }] },
            options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, max:10 } } }
          });
        }
      }
    }

    // Admin charts are filtered at server-side when a program is selected
  })();
</script>
</div>
{% endblock %}
