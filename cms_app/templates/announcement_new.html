{% extends 'layout.html' %}
{% import '_macros.html' as ui %}
{% block content %}
<div class="container py-4">
  <div class="section-header d-flex justify-content-between align-items-center mb-3">
    {% set role_display = (current_user.role if current_user.is_authenticated else 'Guest') %}
    <h2 class="mb-0 title d-flex align-items-center">New Announcement <span class="role-badge ms-2">{{ role_display|capitalize }}</span></h2>
    <div class="actions">
      {{ ui.back_link(url_for('main.announcements_list'), 'Back to Announcements') }}
    </div>
  </div>
  {{ ui.breadcrumbs([
    ('Dashboard', url_for('main.dashboard')),
    ('Announcements', url_for('main.announcements_list')),
    ('New', '')
  ]) }}
  {% if errors and errors|length > 0 %}
    <div class="alert alert-danger">{{ errors[0] }}</div>
  {% endif %}
  {% set user_role = (current_user.role or '')|lower %}
  <form method="post" action="{{ url_for('main.announcement_new') }}" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <div class="mb-3">
      <label class="form-label">Title</label>
      <input type="text" name="title" class="form-control" value="{{ form_data.title or '' }}" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Message</label>
      <textarea name="message" class="form-control" rows="4" required>{{ form_data.message or '' }}</textarea>
    </div>
    <div class="mb-3">
      <label class="form-label">Attachments (docx/pdf/xlsx/jpg)</label>
      <input type="file" name="attachments" class="form-control" multiple accept=".pdf,.docx,.xlsx,.jpg,.jpeg">
      <div class="form-text soft-hint">Optional. You can attach multiple files. Allowed: .pdf, .docx, .xlsx, .jpg/.jpeg.</div>
    </div>
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Severity</label>
        <select name="severity" class="form-select">
          {% for s in ['info','success','warning','danger'] %}
            <option value="{{ s }}" {% if (form_data.severity or 'info') == s %}selected{% endif %}>{{ s|capitalize }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">{% if user_role == 'principal' %}Program{% else %}Program (optional){% endif %}</label>
        <select name="program_id_fk" class="form-select" {% if user_role == 'principal' %}{% endif %}>
          {% if user_role in ['admin','clerk'] %}
            <option value="">All Programs</option>
            {% for p in programs %}
              <option value="{{ p.program_id }}" {% if (form_data.program_id_fk or '')|string == (p.program_id|string) %}selected{% endif %}>{{ p.program_name }}</option>
            {% endfor %}
          {% else %}
            {% for p in programs %}
              {% if current_user.program_id_fk and p.program_id == current_user.program_id_fk %}
                <option value="{{ p.program_id }}" selected>{{ p.program_name }}</option>
              {% endif %}
            {% endfor %}
          {% endif %}
        </select>
        {% if user_role == 'principal' %}
          <div class="form-text">As principal, you can announce only to your program.</div>
        {% elif user_role == 'faculty' %}
          <div class="form-text">Staff must select a specific program; global announcements are allowed only for admin/clerk.</div>
        {% endif %}
      </div>
      <div class="col-md-3">
        <label class="form-label">Start At</label>
        <input type="datetime-local" name="start_at" class="form-control" value="{{ form_data.start_at or '' }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">End At (optional)</label>
        <input type="datetime-local" name="end_at" class="form-control" value="{{ form_data.end_at or '' }}">
      </div>
    </div>
    <div class="mt-3">
      <label class="form-label">Audience{% if user_role in ['principal','faculty'] %} (restricted to Students/Staff){% else %} (leave empty for all){% endif %}</label>
      <div class="d-flex flex-wrap gap-3">
        {% set aud = form_data.audience_roles or [] %}
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="audience_roles" id="audStudent" value="student" {% if 'student' in aud %}checked{% endif %}>
          <label class="form-check-label" for="audStudent">Students</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="audience_roles" id="audFaculty" value="faculty" {% if 'faculty' in aud %}checked{% endif %}>
          <label class="form-check-label" for="audFaculty">Staff</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="audience_roles" id="audPrincipal" value="principal" {% if 'principal' in aud %}checked{% endif %} {% if user_role in ['principal','faculty'] %}disabled{% endif %}>
          <label class="form-check-label" for="audPrincipal">Principal</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="audience_roles" id="audClerk" value="clerk" {% if 'clerk' in aud %}checked{% endif %} {% if user_role in ['principal','faculty'] %}disabled{% endif %}>
          <label class="form-check-label" for="audClerk">Clerk</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="audience_roles" id="audAdmin" value="admin" {% if 'admin' in aud %}checked{% endif %} {% if user_role in ['principal','faculty'] %}disabled{% endif %}>
          <label class="form-check-label" for="audAdmin">Admin</label>
        </div>
      </div>
      <div class="form-text soft-hint">
        Check one or more roles to target; leave empty to show to everyone.
      </div>
    </div>
    <div class="mt-3">
      <label class="form-label">Personal recipients (Enrollment Nos)</label>
      <textarea name="recipient_enrollment_nos" id="recipientEnrollmentNos" class="form-control" rows="2" placeholder="e.g. 5034240001, 5034240008">{{ form_data.recipient_enrollment_nos or '' }}</textarea>
      <div class="form-text soft-hint">Private: visible only to listed students and Principal/Clerk. Separate by commas or spaces.</div>
    </div>
    <div class="mt-3">
      <label class="form-label">Pick students</label>
      <div class="d-flex gap-2 align-items-start">
        <div class="flex-grow-1 position-relative">
          <input type="text" id="studentPickerInput" class="form-control" placeholder="Loading directory..." disabled autocomplete="off" />
          <div id="studentSuggestions" class="list-group position-absolute w-100 shadow-lg" style="z-index: 1000; max-height: 400px; overflow-y: auto; display: none;"></div>
        </div>
        <button type="button" class="btn btn-outline-secondary" id="forceSearchBtn" title="Search Server"><i class="bi bi-cloud-download"></i></button>
      </div>
      <div class="d-flex justify-content-between mt-1">
         <div class="form-text soft-hint">Type name/enrollment. Press Enter to search server if not found.</div>
         <div class="small text-muted" id="cacheStatus">Initializing...</div>
      </div>
      
      <div id="recipientChips" class="d-flex flex-wrap gap-2 mt-2"></div>
    </div>
    <div class="form-check mt-3">
      <input class="form-check-input" type="checkbox" name="is_active" id="isActive" {% if form_data.is_active %}checked{% endif %}>
      <label class="form-check-label" for="isActive">Active</label>
    </div>

    <!-- Inline data to avoid JS parser confusion with templating -->
    <script id="studentsData" type="application/json">{{ (students_for_picker or []) | tojson }}</script>
    <script>
      (function() {
        const textArea = document.getElementById('recipientEnrollmentNos');
        const input = document.getElementById('studentPickerInput');
        const forceBtn = document.getElementById('forceSearchBtn');
        const chips = document.getElementById('recipientChips');
        const suggestions = document.getElementById('studentSuggestions');
        const cacheStatus = document.getElementById('cacheStatus');
        
        // We will ignore the pre-loaded template data (studentsData) and use our robust API loader instead
        // This unifies the logic with Quick Payment and View Students
        let allStudents = [];
        let debounceTimer;

        // 1. Initial Load (Tier 1)
        async function loadStudents() {
          try {
            cacheStatus.innerText = "Downloading directory...";
            const resp = await fetch("{{ url_for('main.api_students_search') }}?limit=2000"); 
            const jsonResp = await resp.json();
            const items = (jsonResp.data && jsonResp.data.items) || (jsonResp.items) || [];
            allStudents = items;
            
            input.disabled = false;
            input.placeholder = "Type name, enrollment, or semester...";
            cacheStatus.innerText = `${allStudents.length} students loaded locally.`;
          } catch(e) {
            console.error("Failed to load students", e);
            cacheStatus.innerText = "Offline mode or server error.";
            input.disabled = false;
            input.placeholder = "Search server directly...";
          }
        }
        loadStudents();

        function parseInitial() {
          const raw = (textArea.value || '').replace(/\n/g, ' ').replace(/,/g, ' ');
          const toks = raw.split(' ').map(t => t.trim()).filter(Boolean);
          const seen = new Set();
          window.recipients = []; // Global scope for simplicity in this context
          for (const t of toks) { if (!seen.has(t)) { seen.add(t); window.recipients.push(t); } }
        }

        function formatStudentLabel(s) {
          const semTxt = (s.semester != null && s.semester !== '') ? 'Sem ' + s.semester : '';
          const progTxt = (s.program_name) ? s.program_name : '';
          const meta = [progTxt, semTxt].filter(Boolean).join(' • ');
          return `${s.enrollment_no} — ${s.name}${meta ? ' (' + meta + ')' : ''}`;
        }

        function renderChips() {
          chips.innerHTML = '';
          (window.recipients || []).forEach(enr => {
            const span = document.createElement('span');
            span.className = 'badge bg-secondary rounded-pill px-2 py-1';
            // Try to find details in loaded list
            const st = allStudents.find(x => x.enrollment_no === enr);
            const label = st ? formatStudentLabel(st) : enr;
            span.textContent = label + ' ';
            const close = document.createElement('button');
            close.type = 'button';
            close.className = 'btn btn-sm btn-light ms-1';
            close.textContent = '×';
            close.setAttribute('data-enr', enr);
            close.addEventListener('click', (e) => {
              const val = e.currentTarget.getAttribute('data-enr');
              window.recipients = window.recipients.filter(r => r !== val);
              renderChips();
            });
            span.appendChild(close);
            chips.appendChild(span);
          });
          textArea.value = (window.recipients || []).join(', ');
        }

        function addRecipient(val) {
          const enr = (val || '').trim();
          if (!enr) return;
          if (!window.recipients) window.recipients = [];
          if (!window.recipients.includes(enr)) {
            window.recipients.push(enr);
            renderChips();
          }
          input.value = '';
          suggestions.innerHTML = '';
        }

        // 2. Hybrid Search Logic
        function performSearch(query, forceServer = false) {
          if (!query) {
             suggestions.style.display = 'none';
             return;
          }
          
          const q = query.toLowerCase();
          let matches = allStudents.filter(s => {
            if (s.enrollment_no && s.enrollment_no.toLowerCase().includes(q)) return true;
            const full = (s.name || '').toLowerCase();
            return full.includes(q);
          }).slice(0, 15);

          if (matches.length > 0 && !forceServer) {
            showSuggestions(matches, false);
          } else {
            fetchServerSearch(query);
          }
        }

        async function fetchServerSearch(query) {
          suggestions.innerHTML = '<div class="list-group-item text-muted"><span class="spinner-border spinner-border-sm me-2"></span>Searching server archive...</div>';
          suggestions.style.display = 'block';
          
          try {
            const url = new URL("{{ url_for('main.api_students_search') }}", window.location.origin);
            url.searchParams.set('q', query);
            url.searchParams.set('limit', 50);
            
            const resp = await fetch(url.toString());
            const jsonResp = await resp.json();
            const items = (jsonResp.data && jsonResp.data.items) || (jsonResp.items) || [];
            
            if (items.length === 0) {
               suggestions.innerHTML = '<div class="list-group-item text-center text-muted py-3">No matching students found.</div>';
            } else {
               showSuggestions(items, true);
            }
          } catch(e) {
            suggestions.innerHTML = '<div class="list-group-item text-danger">Server search failed.</div>';
          }
        }

        function showSuggestions(items, isServerResult) {
          suggestions.innerHTML = '';
          const header = document.createElement('div');
          header.className = 'list-group-item bg-light fw-bold text-muted small py-2 d-flex justify-content-between';
          header.innerHTML = `<span>${isServerResult ? 'Server Results' : 'Instant Results'}</span><span class="badge bg-secondary">${items.length}</span>`;
          suggestions.appendChild(header);

          items.forEach(s => {
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'list-group-item list-group-item-action text-start';
            item.textContent = formatStudentLabel(s);
            item.addEventListener('click', () => addRecipient(s.enrollment_no));
            suggestions.appendChild(item);
          });
          
          if (!isServerResult) {
              const footer = document.createElement('div');
              footer.className = 'list-group-item list-group-item-action text-center text-primary small py-2';
              footer.style.cursor = 'pointer';
              footer.innerHTML = '<i class="bi bi-cloud-download me-1"></i> Not here? Search entire server';
              footer.onclick = () => fetchServerSearch(input.value);
              suggestions.appendChild(footer);
          }
          suggestions.style.display = 'block';
        }

        input.addEventListener('input', function() {
          const q = (this.value || '').trim();
          if (debounceTimer) clearTimeout(debounceTimer);
          if (q.length < 2) { suggestions.style.display = 'none'; return; }
          debounceTimer = setTimeout(() => performSearch(q), 300);
        });

        input.addEventListener('keydown', function(e) {
           if (e.key === 'Enter') {
               e.preventDefault();
               performSearch(this.value, true);
           }
        });
        
        forceBtn.addEventListener('click', () => performSearch(input.value, true));

        document.addEventListener('click', (e) => { 
           if (!suggestions.contains(e.target) && e.target !== input && e.target !== forceBtn) suggestions.style.display = 'none'; 
        });

        parseInitial();
        renderChips();
      })();
    </script>
    <div class="mt-3">
      <button class="btn btn-primary" type="submit">Create</button>
      <a class="btn btn-secondary" href="{{ url_for('main.announcements_list') }}">Cancel</a>
    </div>
  </form>
</div>
{% endblock %}